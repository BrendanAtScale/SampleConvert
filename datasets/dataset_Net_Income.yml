unique_name: dataset_Net_Income
object_type: dataset
label: Net Income
columns:
  - name: ANP
    data_type: double
  - name: ProjectID
    data_type: long
  - name: TaskID
    data_type: string
  - name: Net Income Period Type
    data_type: string
  - name: Net Income Start Date
    data_type: datetime
  - name: countrows1
    data_type: int
    sql: '1'
connection_id: SQL42
sql: >-
  SELECT CombinedData.PROJECT_ID ProjectID, CombinedData.TASK_ID TaskID,
  CombinedData.[Net Income Period Type], CombinedData.[Net Income Start Date],
  CombinedData.ANP FROM ( SELECT ITD_Net_Income_By_Month.PROJECT_ID,
  ITD_Net_Income_By_Month.TASK_ID, ITD_Net_Income_By_Month.[Net Income Period
  Type], (CASE WHEN YEAR(ITD_Net_Income_By_Month.PERIOD_START_DATE) < 2000 THEN
  DATEFROMPARTS(2000, 1, 1) ELSE ITD_Net_Income_By_Month.PERIOD_START_DATE END)
  AS [Net Income Start Date], ITD_Net_Income_By_Month.Curr_ITD_Net_Income -
  ISNULL(Prev_Period_Net_Income.MEASURE_VALUE_BRDN_PFC, 0) AS ANP FROM ( SELECT
  NetIncome.PROJECT_ID, NetIncome.TASK_ID, 'ITD' [Net Income Period Type],
  NetIncome.PERIOD_START_DATE, NetIncome.MEASURE_VALUE_BRDN_PFC AS
  Curr_ITD_Net_Income, MAX(PrevNetIncome.PERIOD_START_DATE) AS Prev_Period_Start
  FROM AnalyticsSource.dbo.NetIncome LEFT OUTER JOIN
  AnalyticsSource.dbo.NetIncome AS PrevNetIncome ON NetIncome.TASK_ID =
  PrevNetIncome.TASK_ID AND (PrevNetIncome.PERIOD_TYPE = 'ITD') AND
  (PrevNetIncome.PERIOD_START_DATE < NetIncome.PERIOD_START_DATE) WHERE
  (PrevNetIncome.MEASURE_VALUE_BRDN_PFC IS NOT NULL) AND (NetIncome.PERIOD_TYPE
  = 'ITD') GROUP BY NetIncome.PROJECT_ID, NetIncome.TASK_ID,
  NetIncome.PERIOD_START_DATE, NetIncome.MEASURE_VALUE_BRDN_PFC ) AS
  ITD_Net_Income_By_Month LEFT OUTER JOIN AnalyticsSource.dbo.NetIncome AS
  Prev_Period_Net_Income ON ITD_Net_Income_By_Month.TASK_ID =
  Prev_Period_Net_Income.TASK_ID AND ITD_Net_Income_By_Month.Prev_Period_Start =
  Prev_Period_Net_Income.PERIOD_START_DATE WHERE
  (ITD_Net_Income_By_Month.Curr_ITD_Net_Income -
  ISNULL(Prev_Period_Net_Income.MEASURE_VALUE_BRDN_PFC, 0) <> 0) and
  Prev_Period_Net_Income.PERIOD_TYPE = 'ITD' UNION ALL SELECT
  Initial_Versions.PROJECT_ID, Initial_Versions.TASK_ID, 'ITD' [Net Income
  Period Type], (CASE WHEN YEAR(Initial_Versions.PERIOD_START_DATE) < 2000 THEN
  DATEFROMPARTS(2000, 1, 1) ELSE Initial_Versions.PERIOD_START_DATE END) AS [Net
  Income Start Date], Initial_Versions.MEASURE_VALUE_BRDN_PFC AS ANP FROM (
  SELECT NetIncome.PROJECT_ID, NetIncome.TASK_ID, NetIncome.PERIOD_START_DATE,
  NetIncome.MEASURE_VALUE_BRDN_PFC, row_number() over (partition by
  NetIncome.Task_ID order by NetIncome.PERIOD_START_DATE) rn FROM
  AnalyticsSource.dbo.NetIncome WHERE (NetIncome.MEASURE_VALUE_BRDN_PFC IS NOT
  NULL) AND (NetIncome.PERIOD_TYPE = 'ITD') ) AS Initial_Versions WHERE
  (Initial_Versions.MEASURE_VALUE_BRDN_PFC <> 0) AND Initial_Versions.rn = 1 --
  earliest period start date UNION ALL SELECT NetIncome.PROJECT_ID,
  NetIncome.TASK_ID, 'PTD' [Net Income Period Type], (CASE WHEN
  YEAR(NetIncome.PERIOD_START_DATE) < 2000 THEN DATEFROMPARTS(2000, 1, 1) ELSE
  NetIncome.PERIOD_START_DATE END) AS [Net Income Start Date],
  NetIncome.MEASURE_VALUE_BRDN_PFC AS ANP FROM AnalyticsSource.dbo.NetIncome
  WHERE (NetIncome.PERIOD_TYPE = 'PTD') AND (NetIncome.MEASURE_VALUE_BRDN_PFC <>
  0) ) AS CombinedData INNER JOIN /* direct projects with to-date actuals costs
  or non-converted approved cost budgets, primary cost forecasts, or primary
  revenue forecasts with baselined dates on or after 7/1/2013 No projects owned
  by AZCO or CSR */ (SELECT DISTINCT FinancialPlanVersions.PROJECT_ID FROM
  AnalyticsSource.dbo.FinancialPlanVersions INNER JOIN
  EnterpriseDataStore.dbo.Projects AS BillProj ON
  FinancialPlanVersions.PROJECT_ID = BillProj.Project_ID AND BillProj.DirectFlag
  = 'Y' left join AnalyticsSource.dbo.OperatingUnits on
  OperatingUnits.ORGANIZATION_ID = BillProj.OrgId and OperatingUnits.NAME in
  ('AZCO OU', 'CONSTRUCTORS OU') WHERE ((FinancialPlanVersions.FIN_PLAN_TYPE_ID
  IN (10040, 10060, 10062)) /* Approved Cost Budget, Primary Cost Forecast,
  Primary Revenue Forecast */ AND (FinancialPlanVersions.VERSION_NAME <>
  'CONVERTED VERSION') AND (FinancialPlanVersions.BASELINED_DATE >=
  try_convert(date, '2013-07-01')) OR (FinancialPlanVersions.FIN_PLAN_TYPE_ID =
  156596) /* To-Date Actuals Cost */ ) and OperatingUnits.ORGANIZATION_ID is
  null -- no income for AZCO and CSR union /* direct projects with to-date
  actuals costs or non-converted approved cost budgets, primary cost forecasts,
  or primary revenue forecasts with baselined dates on or after 7/1/2013 */
  SELECT DISTINCT FinancialPlanVersions.PROJECT_ID FROM
  AnalyticsSource.east.FinancialPlanVersions INNER JOIN
  EnterpriseDataStore.east.Projects AS BillProj ON
  FinancialPlanVersions.PROJECT_ID = BillProj.Project_ID AND BillProj.DirectFlag
  = 'Y' WHERE (FinancialPlanVersions.FIN_PLAN_TYPE_ID IN (10040, 10060, 10062))
  /* Approved Cost Budget, Primary Cost Forecast, Primary Revenue Forecast */
  AND (FinancialPlanVersions.VERSION_NAME <> 'CONVERTED VERSION') AND
  (FinancialPlanVersions.BASELINED_DATE >= try_convert(date, '2013-07-01')) OR
  (FinancialPlanVersions.FIN_PLAN_TYPE_ID = 156596) /* To-Date Actuals Cost */ )
  AS ValidProjects ON CombinedData.PROJECT_ID = ValidProjects.PROJECT_ID CROSS
  JOIN SISOT.dbo.PSMSettings WHERE (CombinedData.[Net Income Start Date] <=
  PSMSettings.NetIncomeCutoffDate)
