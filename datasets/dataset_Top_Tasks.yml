unique_name: dataset_Top_Tasks
object_type: dataset
label: Top Tasks
columns:
  - name: TopTaskID
    data_type: string
  - name: ProjectID
    data_type: long
  - name: Top Task Number
    data_type: string
  - name: Top Task Name
    data_type: string
  - name: Top Task Owning Company
    data_type: string
  - name: Top Task Owning Global Practice
    data_type: string
  - name: Top Task Owning Office Location
    data_type: string
  - name: Top Task Owning Department
    data_type: string
  - name: Top Task Owning Organization Name
    data_type: string
  - name: Top Task Manager Account Name
    data_type: string
  - name: Top Task Manager Employee Number
    data_type: string
  - name: Top Task Manager Is Active
    data_type: boolean
  - name: Top Task Project Loc Country Code
    data_type: string
  - name: Top Task Project Loc County
    data_type: string
  - name: Top Task Project Loc State
    data_type: string
  - name: Top Task Project Loc City
    data_type: string
  - name: Top Task Project Loc Zip
    data_type: string
  - name: Top Task Work Loc Country Code
    data_type: string
  - name: Top Task Work Loc County
    data_type: string
  - name: Top Task Work Loc State
    data_type: string
  - name: Top Task Work Loc City
    data_type: string
  - name: Top Task Work Loc Zip
    data_type: string
  - name: Top Task Description
    data_type: string
  - name: ProjectRoleID
    data_type: string
  - name: Project Role
    data_type: string
  - name: AssetID
    data_type: string
  - name: Asset Type Global Practice
    data_type: string
  - name: Asset
    data_type: string
  - name: ServiceID
    data_type: string
  - name: Service
    data_type: string
  - name: ServiceDetailID
    data_type: string
  - name: Service Detail
    data_type: string
  - name: Project Number
    data_type: string
  - name: Contract Group
    data_type: string
  - name: Performance Obligation Number
    data_type: string
  - name: Top Task Site City
    data_type: string
  - name: Top Task Site City State Postal Country
    data_type: string
  - name: Top Task Site Country Code
    data_type: string
  - name: Top Task Site Country Name
    data_type: string
  - name: Top Task Site County
    data_type: string
  - name: Top Task Site Postal Code
    data_type: string
  - name: Top Task Site State Code
    data_type: string
  - name: Top Task Site State Name
    data_type: string
  - name: Project-Top Task
    data_type: string
  - name: Top Task Friendly Name
    data_type: string
  - name: Top Task Friendly Name (long)
    data_type: string
  - name: Top Task Type
    data_type: string
  - name: Top Task GP Dept
    data_type: string
  - name: TTGPLoc
    data_type: string
  - name: CDB Partnered Net Income Organization Name
    data_type: string
  - name: Top Task Manager
    data_type: string
  - name: Top Task Manager Email
    data_type: string
  - name: Top Task Number and Name
    data_type: string
  - name: Top Task Owning Business Line
    data_type: string
  - name: Billing Method
    data_type: string
  - name: Latest Bill Rate Schedule
    data_type: string
  - name: RelatedBPBELM
    data_type: double
  - name: LCM YTD OHM
    data_type: double
  - name: Top Task Intercompany Elimination Source Operating Unit ID
    data_type: string
  - name: Top Task Intercompany Elimination Source Operating Unit
    data_type: string
  - name: Top Task Group ID
    data_type: string
  - name: Top Task Includes Child Intercompany Task Flag
    data_type: string
  - name: Intercompany Top Task Flag
    data_type: string
  - name: Top Task Owning Organization ID
    data_type: long
  - name: Top Task Business Line Global Practice
    data_type: string
  - name: Top Task Engineering or Construction Flag
    data_type: string
  - name: CDB Partnered Net Income Approved Percent
    data_type: double
  - name: CDB Partnered Net Income Applied Percent
    data_type: double
  - name: YTDPlanKeyBEM
    data_type: double
    sql: >-
      null /*LOOKUPVALUE('GBM YTD Plan BEM'[YTD Plan Key BEM], 'GBM YTD Plan
      BEM'[GlobalPractice], 'Top Tasks'[Top Task Owning Global Practice], 'GBM
      YTD Plan BEM'[OfficeLocation], 'Top Tasks'[Top Task Owning Office
      Location]) TODO: Replace with valid SQL*/
  - name: countrows1
    data_type: int
    sql: '1'
connection_id: SQL42
sql: >-
  SELECT distinct Top_Tasks.TopTaskID -- 716,150 , Top_Tasks.ProjectID ,
  Projects.[Project Number] , Right('000000' + Projects.[Project Number], 6) +
  '-' + Top_Tasks.[Top Task Number] [Project-Top Task] , Top_Tasks.[Top Task
  Number] , Top_Tasks.[Top Task Name] , Top_Tasks.[Top Task Number and Name]
  [Top Task Friendly Name] , null [Top Task Friendly Name (long)] ,
  Top_Tasks.[Top Task Number and Name] , case when Top_Tasks.[Top Task Number] =
  'LOANED/BORROWED' then 'LB' when Top_Tasks.TopTaskID > 0 then 'Ecosys' when
  Top_Tasks.TopTaskID = Top_Tasks.ProjectID * -1 then 'Project' else 'CDB
  Recirc' end [Top Task Type] , Top_Tasks.[Top Task Owning Company] ,
  Top_Tasks.[Top Task Owning Global Practice] , Top_Tasks.[Top Task Owning
  Office Location] , Top_Tasks.[Top Task Owning Department] , Top_Tasks.[Top
  Task Owning Organization] [Top Task Owning Organization Name] ,
  Top_Tasks.OrganizationID [Top Task Owning Organization ID] , Top_Tasks.[Top
  Task Owning Global Practice] + '-' + Top_Tasks.[Top Task Owning Department]
  [Top Task GP Dept] , Top_Tasks.[Top Task Owning Global Practice] + '.' +
  Top_Tasks.[Top Task Owning Office Location] [TTGPLoc] --, Top_Tasks.[Top Task
  Owning Company] + '.' + Top_Tasks.[Top Task Owning Global Practice] + '.' +
  Top_Tasks.[Top Task Owning Office Location] [CDB Partnered Net Income
  Organization Name] --, coalesce(CDBApprovedPercents.Company,
  CDBAppliedPercents.Company) + '.' + --coalesce(CDBApprovedPercents.[Global
  Practice], CDBAppliedPercents.[Global Practice]) + '.' +
  --coalesce(CDBApprovedPercents.Location, CDBAppliedPercents.Location) +
  --coalesce('.' + CDBApprovedPercents.Department, '.' +
  nullif(CDBAppliedPercents.Department, 'Common'), '') [CDB Partnered Net Income
  Organization Name] , case when Top_Tasks.[Top Task Owning Global Practice] <>
  'CDB' then Top_Tasks.[Top Task Owning Organization] end [CDB Partnered Net
  Income Organization Name] , CDBApprovedPercents.[CDB Partnered Net Income
  Approved Percent] , CDBAppliedPercents.[CDB Partnered Net Income Applied
  Percent] , Top_Tasks.[Top Task Manager Name] [Top Task Manager] ,
  Top_Tasks.[Top Task Manager Email] [Top Task Manager Email] , case when
  Top_Tasks.TopTaskID < 0 then ProjectManagers.Network_Name else
  TaskManagers.Network_Name end [Top Task Manager Account Name] , case when
  Top_Tasks.TopTaskID < 0 then ProjectManagers.Employee_Number else
  TaskManagers.Employee_Number end [Top Task Manager Employee Number] , case
  when Top_Tasks.TopTaskID < 0 then ProjectManagers.Active else
  TaskManagers.Active end [Top Task Manager Is Active] , Top_Tasks.[Top Task
  Site Country Code] [Top Task Project Loc Country Code] , Top_Tasks.[Top Task
  Site County] [Top Task Project Loc County] , Top_Tasks.[Top Task Site State
  Code] [Top Task Project Loc State] , Top_Tasks.[Top Task Site City] [Top Task
  Project Loc City] , Top_Tasks.[Top Task Site Postal Code] [Top Task Project
  Loc Zip] , Top_Tasks.[Top Task Work Location Country Code] [Top Task Work Loc
  Country Code] , Top_Tasks.[Top Task Work Location County] [Top Task Work Loc
  County] , Top_Tasks.[Top Task Work Location State Code] [Top Task Work Loc
  State] , Top_Tasks.[Top Task Work Location City] [Top Task Work Loc City] ,
  Top_Tasks.[Top Task Work Location Postal Code] [Top Task Work Loc Zip] --,
  Top_Tasks.[Obsolete Top Task Market] [Top Task Market] --, Top_Tasks.[Obsolete
  Top Task Submarket] [Top Task Submarket] , case when Top_Tasks.[Top Task
  Description] = 'Unspecified Top Task' then Projects.[Project Description] else
  Top_Tasks.[Top Task Description] end [Top Task Description] ,
  TOP_TASK_ATTRIBUTES.PROJECT_ROLE AS ProjectRoleID , Top_Tasks.[Top Task
  Contract Role] AS [Project Role] , TOP_TASK_ATTRIBUTES.ASSET AssetID ,
  TOP_TASK_ATTRIBUTES.ASSET_TYPE AS [Asset Type Global Practice] ,
  Top_Tasks.[Top Task Client Asset] AS Asset , TOP_TASK_ATTRIBUTES.SERVICE_ID
  ServiceID , Top_Tasks.[Top Task BMCD Service] AS Service ,
  TOP_TASK_ATTRIBUTES.SERVICE_DETAIL_ID ServiceDetailID , Top_Tasks.[Top Task
  BMCD Service Detail] AS [Service Detail] , Top_Tasks.[Top Task Site City] ,
  Top_Tasks.[Top Task Site City State Postal Country] , Top_Tasks.[Top Task Site
  Country Code] , Top_Tasks.[Top Task Site Country Name] , Top_Tasks.[Top Task
  Site County] , Top_Tasks.[Top Task Site Postal Code] , Top_Tasks.[Top Task
  Site State Code] , Top_Tasks.[Top Task Site State Name] , Projects.[Contract
  Group Number] AS [Contract Group] , CASE WHEN ContractGroups.[POB_FLAG] <> 'N'
  THEN Projects.[Contract Group Number] + '-00' ELSE Projects.[Contract Group
  Number] END AS [Performance Obligation Number] , Top_Tasks.[Top Task Owning
  Business Line] , left(Top_Tasks.[Top Task Owning Business Line], 3) [Top Task
  Business Line Global Practice] , case when Top_Tasks.[Top Task Owning Global
  Practice] = 'CDB' then 'Construction' else 'Engineering' end as [Top Task
  Engineering or Construction Flag] /* moved from Billing Methods table */ ,
  Top_Tasks.[Top Task Billing Method] [Billing Method] ,
  COALESCE(BillingMethod.BILL_RATE_SCHEDULE,
  BillingMethodProject.BILL_RATE_SCHEDULE) [Latest Bill Rate Schedule] /* moved
  from BP BELM table */ -- , [BP-BELM].BELM RelatedBPBELM , null RelatedBPBELM
  /* moved from YTD BEM table */ , YTD_BEM.[LCM YTD OHM] ,
  coalesce(Top_Tasks.[Top Task Includes Child Intercompany Task Flag], 'N') [Top
  Task Includes Child Intercompany Task Flag] , Top_Tasks.[Top Task Intercompany
  Elimination Source Operating Unit ID] , Top_Tasks.[Top Task Intercompany
  Elimination Source Operating Unit] , coalesce(Top_Tasks.[Intercompany Top Task
  Flag], 'N') [Intercompany Top Task Flag] , Top_Tasks.[Top Task Group ID] --,
  Net_Income_Per_Head.MULTIPLIER [Global Practice Target PDIP] --,
  ProjectTargetPDIP.Target_Measure [Top Task Target PDIP] FROM
  Model_Common.dbo.Top_Tasks INNER JOIN Model_Common.dbo.Projects ON
  Top_Tasks.ProjectID = Projects.ProjectID and (Projects.[Project Direct Flag] =
  'Y') LEFT OUTER JOIN AnalyticsSource.dbo.Person_Current AS TaskManagers ON
  TaskManagers.Person_ID = Top_Tasks.[Top Task Manager Person ID] -- only use PM
  info for project level top tasks LEFT OUTER JOIN
  AnalyticsSource.dbo.Person_Current AS ProjectManagers ON
  ProjectManagers.Person_ID = Projects.[Project Manager Person ID] and
  Top_Tasks.[Top Task ID] < 0 LEFT OUTER JOIN (select * from
  AnalyticsSource.dbo.TOP_TASK_ATTRIBUTES union all select * from
  AnalyticsSource.east.TOP_TASK_ATTRIBUTES) TOP_TASK_ATTRIBUTES ON
  TOP_TASK_ATTRIBUTES.TOP_TASK_ID = Top_Tasks.[Top Task ID] LEFT OUTER JOIN
  (select project_id, POB_FLAG from AnalyticsSource.dbo.ContractGroups union all
  select project_id, POB_FLAG from AnalyticsSource.east.ContractGroups)
  ContractGroups ON Top_Tasks.ProjectID = ContractGroups.PROJECT_ID LEFT OUTER
  JOIN (select task_id, BILL_RATE_SCHEDULE from
  AnalyticsSource.dbo.BillingMethod where PROJECT_OR_TASK = 'TOP_TASK' union all
  select task_id, BILL_RATE_SCHEDULE from AnalyticsSource.east.BillingMethod
  where PROJECT_OR_TASK = 'TOP_TASK') BillingMethod on Top_Tasks.TopTaskID =
  BillingMethod.TASK_ID and Projects.[Project Billing Level] = 'TOP_TASK' LEFT
  OUTER JOIN (select PROJECT_ID, BILL_RATE_SCHEDULE from
  AnalyticsSource.dbo.BillingMethod where PROJECT_OR_TASK = 'PROJECT' union all
  select task_id, BILL_RATE_SCHEDULE from AnalyticsSource.east.BillingMethod
  where PROJECT_OR_TASK = 'PROJECT') BillingMethodProject on Top_Tasks.TopTaskID
  = BillingMethodProject.PROJECT_ID * -1 /* moved from BP BELM table - hide for
  now, not getting updated */ /*LEFT OUTER JOIN SISOT.dbo. [BP-BELM] on
  [BP-BELM].GP = Top_Tasks.[Top Task Owning Global Practice] and [BP-BELM].Loc =
  Top_Tasks.[Top Task Owning Office Location]*/ left join
  AnalyticsSource.dbo.HR_Org_Segment_Mapping on
  HR_Org_Segment_Mapping.Organization_ID = Top_Tasks.OrganizationID /* moved
  from YTD BEM table */ LEFT OUTER JOIN (SELECT
  (GB_Actual.PERIOD_NET_DR-GB_Actual.PERIOD_NET_CR) - 1 -
  PSMSettings.CurrentYearLM AS [LCM YTD OHM] --, LEFT(GB_SegCmp.COMPANY, 3)
  Company --, LEFT(GB_SegDiv.DIVISION, 3) GlobalPractice --,
  LEFT(GB_SegLoc.LOCATION, 3) Location , GB_Actual.SEGMENT1 , GB_Actual.SEGMENT2
  , GB_Actual.SEGMENT3 FROM PSRStage.dbo.GB_Actual INNER JOIN
  SISOT.dbo.PSMSettings ON GB_Actual.PERIOD_YEAR =
  YEAR(PSMSettings.NetIncomeCutoffDate) AND GB_Actual.PERIOD_NUM =
  MONTH(PSMSettings.NetIncomeCutoffDate) --INNER JOIN PSRStage.dbo.GB_SegCmp ON
  GB_Actual.SEGMENT1 = GB_SegCmp.SEGMENT1 --INNER JOIN PSRStage.dbo.GB_SegDiv ON
  GB_Actual.SEGMENT2 = GB_SegDiv.SEGMENT2 --INNER JOIN PSRStage.dbo.GB_SegLoc ON
  GB_Actual.SEGMENT3 = GB_SegLoc.SEGMENT3 WHERE (GB_Actual.LEDGER_ID = 1) AND
  (GB_Actual.SEGMENT5 = 'BEFY') AND (GB_Actual.PERIOD_NET_DR <> 0) ) YTD_BEM on
  --YTD_BEM.Company = Top_Tasks.[Top Task Owning Company] and
  YTD_BEM.GlobalPractice = Top_Tasks.[Top Task Owning Global Practice] and
  YTD_BEM.Location = Top_Tasks.[Top Task Owning Office Location]
  YTD_BEM.SEGMENT1 = HR_Org_Segment_Mapping.Segment1 and YTD_BEM.SEGMENT2 =
  HR_Org_Segment_Mapping.Segment2 and YTD_BEM.SEGMENT3 =
  HR_Org_Segment_Mapping.Segment3 /*left join
  AnalyticsSource.dbo.Net_Income_Per_Head on Net_Income_Per_Head.Company =
  Top_Tasks.[Top Task Owning Company] and Net_Income_Per_Head.Global_Practice =
  Top_Tasks.[Top Task Owning Global Practice] left join (select task_id,
  Target_Measure from AnalyticsSource.dbo.PDIPTargets union all select task_id,
  Target_Measure from AnalyticsSource.east.PDIPTargets) ProjectTargetPDIP on
  ProjectTargetPDIP.task_id = Top_Tasks.TopTaskID*/ left join ( select distinct
  CDBRecircPercents.project_id , LocationOrganization.Company ,
  LocationOrganization.GLOBAL_PRACTICE [Global Practice] ,
  LocationOrganization.LOCATION --, Organizations.Department ,
  Organizations.OrganizationID , CDBRecircPercents.pct [CDB Partnered Net Income
  Approved Percent] from AnalyticsSource.dbo.CDBRecircPercents left join (select
  project_id, start_date from EnterpriseDataStore.dbo.Projects union all select
  project_id, start_date from EnterpriseDataStore.east.Projects) Projects on
  Projects.Project_ID = CDBRecircPercents.project_id left join
  AnalyticsSource.dbo.LocationOrganization on
  LocationOrganization.LOCATION_ORGANIZATION_ID =
  CDBRecircPercents.location_organization_id left join
  Model_Common.dbo.Organizations on Organizations.OrganizationID =
  CDBRecircPercents.location_organization_id where (LocationOrganization.DATE_TO
  is null or not(coalesce(LocationOrganization.DATE_TO, getdate()) <
  Projects.Start_Date)) --and Organizations.OrganizationID is null -- remove
  percentages at department level ) CDBApprovedPercents on
  CDBApprovedPercents.project_id = Projects.ProjectID and case when
  CDBApprovedPercents.OrganizationID is not null and
  CDBApprovedPercents.OrganizationID = Top_Tasks.OrganizationID then 1 when
  CDBApprovedPercents.OrganizationID is null and CDBApprovedPercents.Company =
  Top_Tasks.[Top Task Owning Company] and CDBApprovedPercents.[Global Practice]
  = Top_Tasks.[Top Task Owning Global Practice] and CDBApprovedPercents.Location
  = Top_Tasks.[Top Task Owning Office Location] then 1 else 0 end = 1 --and case
  when CDBApprovedPercents.Department is null then 1 when
  CDBApprovedPercents.Department = Top_Tasks.[Top Task Owning Department] then 1
  else 0 end = 1 left join ( select CDBJERecircPercents.PROJECT_ID --, (select
  distinct left(Company,3) from PSRStage.dbo.GB_SegCmp where SEGMENT1 =
  CDBJERecircPercents.segment1) Company --, (select distinct left(division,3)
  from PSRStage.dbo.GB_SegDiv where SEGMENT2 = CDBJERecircPercents.segment2)
  [Global Practice] --, (select distinct left(Location,3) from
  PSRStage.dbo.GB_SegLoc where SEGMENT3 = CDBJERecircPercents.segment3) Location
  --, (select distinct DEPARTMENT from PSRStage.dbo.GB_SegDept where SEGMENT4 =
  CDBJERecircPercents.segment4) Department , CDBJERecircPercents.SEGMENT1 ,
  CDBJERecircPercents.SEGMENT2 , CDBJERecircPercents.SEGMENT3 ,
  CDBJERecircPercents.SEGMENT4 , CDBJERecircPercents.pct [CDB Partnered Net
  Income Applied Percent] , try_convert(date, '01-' +
  CDBJERecircPercents.period_name -- Original format mmm-yyyy, add day and
  convert with Mon dd, yyyy format ) date , ROW_NUMBER() over (partition by
  period_name, project_id, segment1, segment2, segment3, segment4 order by
  last_update_date desc) rn from AnalyticsSource.dbo.CDBJERecircPercents where
  -- Original format mmm-yyyy, add day and convert with Mon dd, yyyy format
  try_convert(date, '01-' + CDBJERecircPercents.period_name) = -- get entries
  from PFMCDBGLMonth (select datefromparts(year(PFMCDBGLMonth),
  month(PFMCDBGLMonth), 1) from SISOT.dbo.PSMSettings) --and
  CDBJERecircPercents.segment4 = '999' -- remove percentages at department level
  ) CDBAppliedPercents on CDBAppliedPercents.project_id = Projects.ProjectID and
  CDBAppliedPercents.SEGMENT1 = HR_Org_Segment_Mapping.Segment1 and
  CDBAppliedPercents.SEGMENT2 = HR_Org_Segment_Mapping.Segment2 and
  CDBAppliedPercents.SEGMENT3 = HR_Org_Segment_Mapping.Segment3 and case when
  CDBAppliedPercents.SEGMENT4 is null then 1 when CDBAppliedPercents.SEGMENT4 =
  HR_Org_Segment_Mapping.Segment4 then 1 else 0 end = 1 and
  CDBAppliedPercents.rn = 1 -- remove extra journal entries /* Do not include
  actual top tasks if the billing level of the project is PROJECT */ WHERE
  ((Projects.[Project Billing Level] = 'TOP_TASK' OR Projects.[Project Billing
  Level] IS NULL) or Top_Tasks.[Top Task ID] < 0) UNION ALL SELECT distinct case
  when projects.ProjectID is not null then '-' + convert(varchar(20),
  Projects.ProjectID) + '.' + AdditionalTopTasks.segment1 +
  AdditionalTopTasks.segment2 + AdditionalTopTasks.segment3 +
  AdditionalTopTasks.segment4 else '1' + AdditionalTopTasks.segment1 +
  AdditionalTopTasks.segment2 + AdditionalTopTasks.segment3 +
  AdditionalTopTasks.segment4 end TopTaskID , coalesce(convert(varchar(20),
  Projects.ProjectID), '1' + AdditionalTopTasks.segment1 +
  AdditionalTopTasks.segment2 + AdditionalTopTasks.segment3 +
  AdditionalTopTasks.segment4) AS ProjectID , coalesce(convert(varchar(20),
  Projects.[Project Number]), '1' + AdditionalTopTasks.segment1 +
  AdditionalTopTasks.segment2 + AdditionalTopTasks.segment3 +
  AdditionalTopTasks.segment4) AS [Project Number] , Right('000000' +
  coalesce(convert(varchar(20), Projects.[Project Number]), '1' +
  AdditionalTopTasks.segment1 + AdditionalTopTasks.segment2 +
  AdditionalTopTasks.segment3 + AdditionalTopTasks.segment4), 6) + '-0'
  [Project-Top Task] , '0' AS [Top Task Number] , 'Unspecified Top Task' AS [Top
  Task Name] , '0 - Unspecified Top Task' [Top Task Friendly Name] , null [Top
  Task Friendly Name (long)] , '0 - Unspecified Top Task' [Top Task Number and
  Name] , 'CDB RECIRC/ PDIP' [Top Task Type] , CMP.Company [Top Task Owning
  Company] , DIV.[Global Practice] [Top Task Owning Global Practice] ,
  LOC.[Office Location] [Top Task Owning Office Location] ,
  coalesce(Orgs.Department, DEPT.Department) AS [Top Task Owning Department] ,
  case when orgs.OrganizationID is null then 'Invalid Costing Organization' else
  Orgs.OrganizationName end AS [Top Task Owning Organization Name] ,
  Orgs.OrganizationID AS [Top Task Owning Organization ID] , DIV.[Global
  Practice] + '-' + coalesce(Orgs.Department, DEPT.Department) [Top Task GP
  Dept] , DIV.[Global Practice] + '.' + LOC.[Office Location] [TTGPLoc] --,
  coalesce(CDBApprovedPercents.Company, CDBAppliedPercents.Company) + '.' +
  --coalesce(CDBApprovedPercents.[Global Practice], CDBAppliedPercents.[Global
  Practice]) + '.' + --coalesce(CDBApprovedPercents.Location,
  CDBAppliedPercents.Location) + --coalesce('.' +
  CDBApprovedPercents.Department, '.' + nullif(CDBAppliedPercents.Department,
  'Common'), '') [CDB Partnered Net Income Organization Name] , case when
  CMP.Company = 'CDB' then null when orgs.OrganizationID is null then 'Invalid
  Costing Organization' else Orgs.OrganizationName end [CDB Partnered Net Income
  Organization Name] , CDBApprovedPercents.[CDB Partnered Net Income Approved
  Percent] , CDBAppliedPercents.[CDB Partnered Net Income Applied Percent] ,
  Projects.[Project Manager Name] [Top Task Manager] , Projects.[Project Manager
  Email] [Top Task Manager Email] , Person_Current.Network_Name AS [Top Task
  Manager Account Name] , Person_Current.Employee_Number AS [Top Task Manager
  Employee Number] , Person_Current.Active AS [Top Task Manager Is Active] ,
  Projects.[Project Site Country Code] AS [Top Task Project Loc Country Code] ,
  Projects.[Project Site County] AS [Top Task Project Loc County] ,
  Projects.[Project Site State Name] AS [Top Task Project Loc State] ,
  Projects.[Project Site City] AS [Top Task Project Loc City] ,
  Projects.[Project Site Postal Code] AS [Top Task Project Loc Zip] ,
  Projects.[Project Work Location Country Code] AS [Top Task Work Loc Country
  Code] , Projects.[Project Work Location County] AS [Top Task Work Loc County]
  , Projects.[Project Work Location State Name] AS [Top Task Work Loc State] ,
  Projects.[Project Work Location City] AS [Top Task Work Loc City] ,
  Projects.[Project Work Location Postal Code] AS [Top Task Work Loc Zip] --,
  Projects.[Obsolete Project Market] AS [Top Task Market] --, Projects.[Obsolete
  Project Submarket] AS [Top Task Submarket] , Projects.[Project Description] AS
  [Top Task Description] , NULL AS ProjectRoleID, NULL AS [Project Role], NULL
  AS AssetID, NULL AS [Asset Type Global Practice], NULL AS Asset, NULL AS
  ServiceID, NULL AS Service, NULL AS ServiceDetailID, NULL AS [Service Detail],
  NULL AS [Top Task Site City], NULL AS [Top Task Site City State Postal
  Country], NULL AS [Top Task Site Country Code], NULL AS [Top Task Site Country
  Name], NULL AS [Top Task Site County], NULL AS [Top Task Site Postal Code],
  NULL AS [Top Task Site State Code], NULL AS [Top Task Site State Name] ,
  coalesce(Projects.[Contract Group Number], 'ADD-1' +
  AdditionalTopTasks.segment2 + AdditionalTopTasks.segment3) AS [Contract Group]
  , CASE WHEN ContractGroups.[POB_FLAG] <> 'N' THEN Projects.[Contract Group
  Number] + '-00' ELSE Projects.[Contract Group Number] END AS [Performance
  Obligation Number] --, case when Orgs.BusinessLineCount > 1 then 'multiple
  mapped business lines - use GP.Dept' when Orgs.BusinessLineCount = 0 then 'No
  mapped business line' when Orgs.BusinessLineCount = 1 then 'mapping good' end
  BusinessLineCheck , CASE WHEN Orgs.BusinessLineCount <> 1 or
  Orgs.BusinessLineCount is null THEN DIV.[Global Practice] + '.' +
  coalesce(Orgs.Department, DEPT.Department) ELSE Orgs.BusinessLine END AS [Top
  Task Owning Business Line] , CASE WHEN Orgs.BusinessLineCount <> 1 or
  Orgs.BusinessLineCount is null THEN DIV.[Global Practice] else
  left(Orgs.BusinessLine, 3) END AS [Top Task Business Line Global Practice] ,
  case when DIV.[Global Practice] = 'CDB' then 'Construction' else 'Engineering'
  end as [Top Task Engineering or Construction Flag] , NULL [Billing Method] ,
  NULL [Latest Bill Rate Schedule] /* moved from BP BELM table */ --,
  [BP-BELM].BELM , null RelatedBPBELM /* moved from YTD BEM table */ ,
  YTD_BEM.[LCM YTD OHM] , null [Top Task Includes Child Intercompany Task Flag]
  , null [Top Task Intercompany Elimination Source Operating Unit ID] , null
  [Top Task Intercompany Elimination Source Operating Unit] , null [Intercompany
  Top Task Flag] , null [Top Task Group ID] --, null [Global Practice Target
  PDIP] --, null [Top Task Target PDIP] FROM ( -- CDB Recirc SELECT distinct
  CDBRecircAccounts.Project_ID , CDBRecircAccounts.segment1 ,
  CDBRecircAccounts.segment2 , CDBRecircAccounts.segment3 ,
  CDBRecircAccounts.segment4 FROM AnalyticsSource.dbo.CDBRecircAccounts union
  SELECT distinct CDBRecircAccountsHistory.Project_ID ,
  CDBRecircAccountsHistory.segment1 , CDBRecircAccountsHistory.segment2 ,
  CDBRecircAccountsHistory.segment3 , '999' segment4 FROM
  AnalyticsSource.dbo.CDBRecircAccountsHistory union -- Ecosys Estimates
  (Dealsheets) SELECT Projects.Project_ID , CMP.SEGMENT1 , DIV.SEGMENT2 ,
  LOC.SEGMENT3 , '999' segment4 FROM [Ecosys].[EcoSys].[EstimateSummary] join
  Ecosys.EcoSys.EstimateProjects on EstimateSummary.EstimateInternalID =
  EstimateProjects.EstimateInternalID join (select project_id, project_no from
  EnterpriseDataStore.dbo.Projects where directflag = 'Y' union all select
  project_id, project_no from EnterpriseDataStore.east.Projects where directflag
  = 'Y') Projects on Projects.project_no = EstimateProjects.ProjectNumber LEFT
  OUTER JOIN (SELECT UPPER(LEFT(GB_SegCmp.COMPANY,5)) AS Company,
  GB_SegCmp.SEGMENT1 FROM PSRStage.dbo.GB_SegCmp WHERE GB_SegCmp.SEGMENT1 NOT
  LIKE '9%') CMP ON EstimateSummary.[EstimateParticipatingCompany] + ' -' =
  CMP.Company LEFT OUTER JOIN (SELECT UPPER(LEFT(GB_SegDiv.DIVISION,5)) AS
  [Global Practice], GB_SegDiv.SEGMENT2 FROM PSRStage.dbo.GB_SegDiv WHERE
  GB_SegDiv.SEGMENT2 NOT LIKE '9%') DIV ON
  EstimateSummary.[EstimateParticipatingGlobalPractice] + ' -' = DIV.[Global
  Practice] LEFT OUTER JOIN (SELECT UPPER(LEFT(GB_SegLoc.LOCATION,5)) AS [Office
  Location], GB_SegLoc.SEGMENT3 FROM PSRStage.dbo.GB_SegLoc WHERE
  GB_SegLoc.SEGMENT3 NOT LIKE '9%' OR GB_SegLoc.SEGMENT3 = '999') LOC ON
  EstimateSummary.[EstimateParticipatingOfficeLocation] + ' -' = LOC.[Office
  Location] union SELECT distinct nullif(PDIP_CMFE_Equity_JE.Project_ID, '')
  Project_ID , PDIP_CMFE_Equity_JE.segment1 , PDIP_CMFE_Equity_JE.segment2 ,
  PDIP_CMFE_Equity_JE.segment3 , PDIP_CMFE_Equity_JE.segment4 FROM
  AnalyticsSource.dbo.PDIP_CMFE_Equity_JE WHERE -- Equity Charge
  (PDIP_CMFE_Equity_JE.SEGMENT5 = 'EQCH' --and not(PDIP_CMFE_Equity_JE.SEGMENT1
  IN ('013','044','047','022')) -- UKO, CAN, AZC, CSR and
  not(PDIP_CMFE_Equity_JE.SEGMENT1 IN ('044','047')) -- AZC, CSR and
  NOT(PDIP_CMFE_Equity_JE.SEGMENT2 IN ('101')) -- M&S --and
  NOT(PDIP_CMFE_Equity_JE.SEGMENT3 IN ('731')) -- UKO and
  not((PDIP_CMFE_Equity_JE.segment1 = 022 or PDIP_CMFE_Equity_JE.segment3 = 731)
  and PDIP_CMFE_Equity_JE.ledger_id <> 3075) -- keep one ledger for UKO ) or --
  CDB Recirc Provided/Received FTE PDIP_CMFE_Equity_JE.SEGMENT5 in ('CMFE',
  'CAFE', 'CRFE') union SELECT distinct
  nullif(PDIPAccountingJournalEntries.Project_ID, '') Project_ID ,
  PDIPAccountingJournalEntries.segment1 , PDIPAccountingJournalEntries.segment2
  , PDIPAccountingJournalEntries.segment3 ,
  PDIPAccountingJournalEntries.segment4 FROM
  AnalyticsSource.dbo.PDIPAccountingJournalEntries WHERE -- CDB Recirc
  Provided/Received FTE SEGMENT5 = 'CWFE' ) AdditionalTopTasks LEFT OUTER JOIN
  (SELECT UPPER(LEFT(GB_SegCmp.COMPANY,3)) AS Company, GB_SegCmp.SEGMENT1 FROM
  PSRStage.dbo.GB_SegCmp WHERE GB_SegCmp.SEGMENT1 NOT LIKE '9%') CMP ON
  AdditionalTopTasks.SEGMENT1 = CMP.SEGMENT1 LEFT OUTER JOIN (SELECT
  UPPER(LEFT(GB_SegDiv.DIVISION,3)) AS [Global Practice], GB_SegDiv.SEGMENT2
  FROM PSRStage.dbo.GB_SegDiv WHERE GB_SegDiv.SEGMENT2 NOT LIKE '9%') DIV ON
  AdditionalTopTasks.SEGMENT2 = DIV.SEGMENT2 LEFT OUTER JOIN (SELECT
  UPPER(LEFT(GB_SegLoc.LOCATION,3)) AS [Office Location], GB_SegLoc.SEGMENT3
  FROM PSRStage.dbo.GB_SegLoc WHERE GB_SegLoc.SEGMENT3 NOT LIKE '9%' OR
  GB_SegLoc.SEGMENT3 = '999') LOC ON AdditionalTopTasks.SEGMENT3 = LOC.SEGMENT3
  LEFT OUTER JOIN (SELECT GB_SegDept.Department, GB_SegDept.SEGMENT4 FROM
  PSRStage.dbo.GB_SegDept) DEPT ON AdditionalTopTasks.SEGMENT4 = DEPT.SEGMENT4
  left join (SELECT distinct Organizations.OrganizationID ,
  Organizations.OrganizationName , HR_Org_Segment_Mapping.Segment1,
  HR_Org_Segment_Mapping.Segment2, HR_Org_Segment_Mapping.Segment3,
  HR_Org_Segment_Mapping.Segment4 , Organizations.Department ,
  COUNT(CRMBusinessLine.BusinessLine) OVER (PARTITION BY
  Organizations.OrganizationID) AS BusinessLineCount ,
  CRMBusinessLine.BusinessLine from (select * from
  EnterpriseDataStore.dbo.Organizations where EndDate is null union all select *
  from EnterpriseDataStore.east.Organizations where EndDate is null)
  Organizations left join AnalyticsSource.dbo.HR_Org_Segment_Mapping on
  Organizations.OrganizationID = HR_Org_Segment_Mapping.Organization_ID LEFT
  OUTER JOIN (select distinct organization_id, businessline from
  AnalyticsSource.dbo.CRMBusinessLine) CRMBusinessLine ON
  Organizations.OrganizationID = CRMBusinessLine.Organization_ID where
  Organizations.OrganizationID not in (8905 /*H&C.TRN.KCM.Bridges*/, 14366
  /*H&C.TRN.KCM.Design*/) ) Orgs on Orgs.Segment1 = AdditionalTopTasks.segment1
  and Orgs.Segment2 = AdditionalTopTasks.segment2 and Orgs.Segment3 =
  AdditionalTopTasks.segment3 and Orgs.Segment4 = AdditionalTopTasks.segment4
  LEFT JOIN Model_Common.dbo.Projects on AdditionalTopTasks.PROJECT_ID =
  Projects.ProjectID and Projects.[Project Direct Flag] = 'Y' LEFT OUTER JOIN
  AnalyticsSource.dbo.Person_Current ON Person_Current.Person_ID =
  Projects.[Project Manager Person ID] LEFT OUTER JOIN
  AnalyticsSource.dbo.ContractGroups ON Projects.ProjectID =
  ContractGroups.PROJECT_ID --/* moved from BP BELM table - hide for now, not
  getting updated */ --LEFT OUTER JOIN SISOT.dbo. [BP-BELM] on [BP-BELM].GP =
  cdb.[Top Task Owning Global Practice] and [BP-BELM].Loc = cdb.[Top Task Owning
  Office Location] /* moved from YTD BEM table */ LEFT OUTER JOIN (SELECT
  (GB_Actual.PERIOD_NET_DR-GB_Actual.PERIOD_NET_CR) - 1 -
  PSMSettings.CurrentYearLM AS [LCM YTD OHM] , GB_Actual.SEGMENT1 ,
  GB_Actual.SEGMENT2 , GB_Actual.SEGMENT3 FROM PSRStage.dbo.GB_Actual INNER JOIN
  SISOT.dbo.PSMSettings ON GB_Actual.PERIOD_YEAR =
  YEAR(PSMSettings.NetIncomeCutoffDate) AND GB_Actual.PERIOD_NUM =
  MONTH(PSMSettings.NetIncomeCutoffDate) WHERE (GB_Actual.LEDGER_ID = 1) AND
  (GB_Actual.SEGMENT5 = 'BEFY') AND (GB_Actual.PERIOD_NET_DR <> 0) ) YTD_BEM on
  YTD_BEM.SEGMENT1 = AdditionalTopTasks.segment1 and YTD_BEM.SEGMENT2 =
  AdditionalTopTasks.segment2 and YTD_BEM.SEGMENT3 = AdditionalTopTasks.segment3
  left join ( select distinct CDBRecircPercents.project_id ,
  LocationOrganization.Company , LocationOrganization.GLOBAL_PRACTICE [Global
  Practice] , LocationOrganization.LOCATION --, Organizations.Department ,
  Organizations.OrganizationID , CDBRecircPercents.pct [CDB Partnered Net Income
  Approved Percent] from AnalyticsSource.dbo.CDBRecircPercents left join (select
  project_id, start_date from EnterpriseDataStore.dbo.Projects union all select
  project_id, start_date from EnterpriseDataStore.east.Projects) Projects on
  Projects.Project_ID = CDBRecircPercents.project_id left join
  AnalyticsSource.dbo.LocationOrganization on
  LocationOrganization.LOCATION_ORGANIZATION_ID =
  CDBRecircPercents.location_organization_id left join
  Model_Common.dbo.Organizations on Organizations.OrganizationID =
  CDBRecircPercents.location_organization_id where (LocationOrganization.DATE_TO
  is null or not(coalesce(LocationOrganization.DATE_TO, getdate()) <
  Projects.Start_Date)) --and Organizations.OrganizationID is null -- remove
  percentages at department level ) CDBApprovedPercents on
  CDBApprovedPercents.project_id = Projects.ProjectID and case when
  CDBApprovedPercents.OrganizationID is not null and
  CDBApprovedPercents.OrganizationID = Orgs.OrganizationID then 1 when
  CDBApprovedPercents.OrganizationID is null and CDBApprovedPercents.Company =
  CMP.Company and CDBApprovedPercents.[Global Practice] = DIV.[Global Practice]
  and CDBApprovedPercents.Location = LOC.[Office Location] then 1 else 0 end = 1
  --and CDBApprovedPercents.Company = CMP.Company --and
  CDBApprovedPercents.[Global Practice] = DIV.[Global Practice] --and
  CDBApprovedPercents.Location = LOC.[Office Location] --and case when
  CDBApprovedPercents.Department is null then 1 when
  CDBApprovedPercents.Department = coalesce(Orgs.Department, DEPT.Department)
  then 1 else 0 end = 1 left join ( select CDBJERecircPercents.PROJECT_ID --,
  (select distinct left(Company,3) from PSRStage.dbo.GB_SegCmp where SEGMENT1 =
  CDBJERecircPercents.segment1) Company --, (select distinct left(division,3)
  from PSRStage.dbo.GB_SegDiv where SEGMENT2 = CDBJERecircPercents.segment2)
  [Global Practice] --, (select distinct left(Location,3) from
  PSRStage.dbo.GB_SegLoc where SEGMENT3 = CDBJERecircPercents.segment3) Location
  --, (select distinct DEPARTMENT from PSRStage.dbo.GB_SegDept where SEGMENT4 =
  CDBJERecircPercents.segment4) Department , CDBJERecircPercents.SEGMENT1 ,
  CDBJERecircPercents.SEGMENT2 , CDBJERecircPercents.SEGMENT3 ,
  CDBJERecircPercents.SEGMENT4 , CDBJERecircPercents.pct [CDB Partnered Net
  Income Applied Percent] , try_convert(date, '01-' +
  CDBJERecircPercents.period_name -- Original format mmm-yyyy, add day and
  convert with Mon dd, yyyy format ) date , ROW_NUMBER() over (partition by
  period_name, project_id, segment1, segment2, segment3, segment4 order by
  last_update_date desc) rn from AnalyticsSource.dbo.CDBJERecircPercents where
  -- Original format mmm-yyyy, add day and convert with Mon dd, yyyy format
  try_convert(date, '01-' + CDBJERecircPercents.period_name) = -- get entries
  from PFMCDBGLMonth (select datefromparts(year(PFMCDBGLMonth),
  month(PFMCDBGLMonth), 1) from SISOT.dbo.PSMSettings) --and
  CDBJERecircPercents.segment4 = '999' -- remove percentages at department level
  ) CDBAppliedPercents on CDBAppliedPercents.project_id = Projects.ProjectID and
  CDBAppliedPercents.SEGMENT1 = AdditionalTopTasks.Segment1 and
  CDBAppliedPercents.SEGMENT2 = AdditionalTopTasks.Segment2 and
  CDBAppliedPercents.SEGMENT3 = AdditionalTopTasks.Segment3 and case when
  CDBAppliedPercents.SEGMENT4 is null then 1 when CDBAppliedPercents.SEGMENT4 =
  AdditionalTopTasks.Segment4 then 1 else 0 end = 1 and CDBAppliedPercents.rn =
  1 -- remove extra journal entries where AdditionalTopTasks.segment1 +
  AdditionalTopTasks.segment2 + AdditionalTopTasks.segment3 +
  AdditionalTopTasks.segment4 is not null
